\documentclass[convert = false]{standalone}
\usepackage[dvipsnames]{xcolor}
\usepackage{tikz}
\usetikzlibrary{shapes.geometric, arrows, petri, positioning, fit, backgrounds, shapes.arrows, arrows.meta, calc}


% style petri nets
\tikzstyle{place}=[circle,thick,draw=blue!75,fill=blue!20,minimum size=6mm]
\tikzstyle{transition}=[rectangle,thick,draw=black!75,fill=black!20,minimum size=4mm]
\tikzstyle{function}=[rectangle,thick,draw=black!75,fill=black!20,minimum size=1cm]
\tikzstyle{submodule}=[draw, dashed, rectangle, rounded corners=2pt, minimum width=1.5cm, inner sep=10pt]
\newcommand{\code}[1]{$\mathtt{#1}$}

\begin{document}

\begin{tikzpicture}[node distance = 2cm, >=stealth', auto]
        \tikzset{%
        pics/CPNModule/.style args={#1}{
            code={
            \begin{scope}
               \node[transition] (t0)  {};
               \node[place, right of = t0]      (p1) {};
               \node[transition, right of = p1] (t1) {};
               \node[transition, below of = t1] (t2) {};
               \node[transition, double, above of = t1] (t3) {};
               \node[place, right of = t1]      (p2) {};
               \node[transition, right of = p2] (t4) {};

               \path[post] (t0) edge (p1);
               \path[post] (t2) edge (p2);
               \path[post] (t3) edge (p2);
               \path[post] (t1) edge (p2);

               \path[pre] (t4) edge (p2);
               \path[pre] (t1) edge (p1);
               \path[pre] (t2) edge (p1);
               \path[pre] (t3) edge (p1);

              \node[submodule,fit=(t0) (t2) (t3) (t4)] (M) {};
              \node[above=2pt of t0, yshift=7mm] {\code{M^{f#1[si]}}}; % label

              % transition
              \node[function, double, above of = M, yshift = 20mm] (fm) {\code{t^{f#1[si]}}};
              \path[dashed] (fm) edge (M);
            \end{scope}
        }}}
        %
        \begin{scope}
            \node (title) at (1mm,10mm) {\textbf{Input}};
            \node (logo) at (0,0) {\includegraphics[width=5mm]{Solidity_logo.png}};
            \node (logo2) at (6mm,0mm) {\includegraphics[width=5mm]{Solidity_logo.png}};
            \node (i1) at (2mm,-10mm) {\code{\{f1_{si},\dots,fi_{si},\dots,fn_{si},}};
            \node at (2mm,-15mm) {\code{\cdots}};
            \node (i2) at (2mm,-20mm) {\code{f1_{sj},\dots,fi_{sj},\dots,fn_{sj}\}}};

            \begin{pgfonlayer}{background}
                \node[submodule, fill=white, fit=(title) (logo) (logo2) (i1) (i2)] (inputs) {};
            \end{pgfonlayer}
        \end{scope}
        %
        \begin{scope}[xshift=7cm, yshift=-1.9cm]
            \pic[local bounding box=M1] {CPNModule=1};
            \pic[local bounding box=M2, right = 1cm of M1, yshift=-10mm]  {CPNModule=i};
            \pic[local bounding box=M3, right = 1cm of M2, yshift=-10mm]  {CPNModule=n};
            \node (title) at ($(M2.north) + (0,10mm)$) {\textbf{Submodels}};
            \node at ($(M1.north) + (3cm,-5mm)$) {$\cdots$};
            \node at ($(M2.north) + (3cm,-5mm)$) {$\cdots$};

            \begin{pgfonlayer}{background}
                \node[submodule,fill=white, fit=(title) (M1) (M2) (M3), xshift=2mm, yshift=2mm] (submodels1) {};
                \node[submodule, fill=white, fit=(title) (M1) (M2) (M3)] (submodels2) {};
            \end{pgfonlayer}
        \end{scope}
        %
        \begin{scope}[xshift=5.6cm, yshift=-10cm]
                % unfolding context
               \node[place]      (p1_0) {};
               \node[transition, above of = p1_0] (t1) {};
               \node[transition, left of = t1] (t2) {};
               \node[transition, draw=gray, fill=none, right of = t1] (t3_0) {};
               \node[place, above of = t1]      (p2_0) {};
               \node[transition, above of = p2_0] (t4_0) {};

               \path[post] (t2) edge (p2_0);
               \path[post,gray] (t3_0) edge (p2_0);
               \path[post] (t1) edge (p2_0);

               \path[pre] (t4_0) edge (p2_0);
               \path[pre] (t1) edge (p1_0);
               \path[pre] (t2) edge (p1_0);
               \path[pre,gray] (t3_0) edge (p1_0);

              \node[submodule,fit=(p1_0) (t2) (t3_0) (t4_0)] (MC) {};
              \node at ($(MC.north) + (0,3mm)$) {\code{M^{C}}}; % label
              \node (labelMC) at ($(MC.south) + (0,-3mm)$) {\texttt{level-0}}; % label

                % unfolding M1
               \node[transition, right of=MC, xshift=2cm] (t0_1)  {};
               \node[place, right of = t0_1]      (p1_1) {};
               \node[transition, right of = p1_1] (t1) {};
               \node[transition, below of = t1] (t2) {};
               \node[transition, double, draw=gray, fill=none, above of = t1, label={[text=gray,xshift=1mm]right:\code{t^{fj[si]}}}] (t3) {};
               \node[place, right of = t1]      (p2_1) {};
               \node[transition, right of = p2_1] (t4_1) {};

               \path[post] (t0_1) edge (p1_1);
               \path[post] (t2) edge (p2_1);
               \path[post,gray] (t3) edge (p2_1);
               \path[post] (t1) edge (p2_1);

               \path[pre] (t4_1) edge (p2_1);
               \path[pre] (t1) edge (p1_1);
               \path[pre] (t2) edge (p1_1);
               \path[pre,gray] (t3) edge (p1_1);

              \node[submodule,fit=(t0_1) (t2) (t3) (t4_1)] (Mi) {};
              \node at ($(Mi.north) + (0,3mm)$) {\code{M^{fi[si]}}}; % label
              \node (labelMi) at ($(Mi.south) + (0,-3mm)$) {\texttt{level-1}}; % label

              % link
              \draw[->] (p1_0) -| (t0_1);
              \draw[->] (t4_1) -- ($(t4_1) + (0,1.3cm)$) -- ($(t3_0) + (0,1.75cm)$) -- (p2_0);

              % unfolding M2
               \node[transition, right of=Mi, xshift=3cm] (t0_2)  {};
               \node[place, right of = t0_2]      (p1_2) {};
               \node[transition, right of = p1_2] (t1) {};
               \node[transition, double, draw=gray, fill=none, below of = t1, label={[text=gray,xshift=-1mm]left:\code{t^{fh[si]}}}] (t2) {};
               \node[transition, above of = t1] (t3) {};
               \node[place, right of = t1]      (p2_2) {};
               \node[transition, right of = p2_2] (t4_2) {};

               \path[post] (t0_2) edge (p1_2);
               \path[post,gray] (t2) edge (p2_2);
               \path[post] (t3) edge (p2_2);
               \path[post] (t1) edge (p2_2);

               \path[pre] (t4_2) edge (p2_2);
               \path[pre] (t1) edge (p1_2);
               \path[pre,gray] (t2) edge (p1_2);
               \path[pre] (t3) edge (p1_2);

              \node[submodule,fit=(t0_2) (t2) (t3) (t4_2)] (Mj) {};
              \node at ($(Mj.north) + (0,3mm)$) {\code{M^{fj[si]}}}; % label
              \node (labelMj) at ($(Mj.south) + (0,-3mm)$) {\texttt{level-2}}; % label

               % link
              \draw[->] (p1_1) -- ($(p1_1) + (0,1.4cm)$) -| (t0_2);
              \draw[->] (t4_2) -- ($(t4_2) - (0,1.3cm)$) -| (p2_1);

              % unfolding M3
               \node[transition, right of=Mj, xshift=3cm] (t0_3)  {};
               \node[place, right of = t0_3]      (p1_3) {};
               \node[transition, double, right of = p1_3, label={above:\code{t^{fk[si]}}}] (t1) {};
               \node[transition, below of = t1] (t2) {};
               \node[transition, above of = t1] (t3) {};
               \node[place, right of = t1]      (p2_3) {};
               \node[transition, right of = p2_3] (t4_3) {};

               \path[post] (t0_3) edge (p1_3);
               \path[post] (t2) edge (p2_3);
               \path[post] (t3) edge (p2_3);
               \path[post] (t1) edge (p2_3);

               \path[pre] (t4_3) edge (p2_3);
               \path[pre] (t1) edge (p1_3);
               \path[pre] (t2) edge (p1_3);
               \path[pre] (t3) edge (p1_3);

              \node[submodule,fit=(t0_3) (t2) (t3) (t4_3)] (Mh) {};
              \node at ($(Mh.north) + (0,3mm)$) {\code{M^{fh[si]}}}; % label
              \node (labelMh) at ($(Mh.south) + (0,-3mm)$) {\texttt{level-3}}; % label

                % link
              \draw[->] (p1_2) -- ($(p1_2) + (0,1.4cm)$) -| (t0_3);
              \draw[->] (t4_3) -- ($(t4_3) - (0,1.4cm)$) -| (p2_2);

                \begin{pgfonlayer}{background}
                    \node[submodule,fill=white, fit=(MC) (labelMC) (Mi) (Mj) (Mh), xshift=2mm, yshift=2mm] (unfolding) {};
                    \draw[|<->|] ($(unfolding.south west) + (0, -4mm)$) -- ++(3.5cm,0) node[inner sep=1mm,midway, below] {Context Layer} ;
                    \draw[<->|] ($(unfolding.south west) + (3.5, -4mm)$) -- node[inner sep=1mm,midway, below] {Smart Contract Layer} ($(unfolding.south east) + (0,-4mm)$);
                    \draw[dotted] ($(unfolding.south west) + (3.5, -2mm)$) -- ($(unfolding.north west) + (3.5, 2mm)$);
                \end{pgfonlayer}
            \end{scope}

         % LTL Property
        \begin{scope}[yshift=-4cm]
            \node (title) at (0,0) {\textbf{LTL Property}};
            \node (title2) at (0,-8mm) {\textbf{+Context Specification}};
            \node[submodule, fill=none, fit=(title2)] (fit2) {};

            \begin{pgfonlayer}{background}
                \node[submodule, fill=white, fit=(title) (fit2)] (property) {};
            \end{pgfonlayer}
        \end{scope}

         % Model Checking
        \begin{scope}[yshift=-8.1cm]
            \node (title) at (0,0) {\textbf{Output}};
            \node (title1) at (0,-7mm) {\texttt{Verified Property?}};
            \node (title2) at (0,-12mm) {\texttt{\textcolor{OliveGreen}{Yes} / \textcolor{BrickRed}{Counterexample}}};

            \begin{pgfonlayer}{background}
                \node[submodule, fill=white, fit=(title) (title2)] (MCK) {};
            \end{pgfonlayer}
        \end{scope}

        \draw[->,thick] (inputs) -- node[yshift=1mm, align=center] {\textbf{(I)}} (submodels2);
        \draw[->,thick] (submodels2) -- node[right, text width=1cm, align=center] {\textbf{(IV)}} (unfolding);
        \draw[->,thick] (fit2) -- node[align=center] {\textbf{(II)}} (MC);

        \draw[->,thick] (unfolding) -- node[above, text width=2cm, yshift=1mm, align=center] {\textbf{Model Checking}} (MCK);
        \draw[thick,-*] (property) -- node[yshift=1mm, align=center] {\textbf{(III)}} ($(unfolding.north) + (.7mm,1.3cm)$);
    \end{tikzpicture}
\end{document}